<!doctype html>
<html lang="en">

<head>
<meta charset="utf-8">

<title>Event Based Programming</title>

<meta name="description" content="explore logging with an emphasis on python">
<meta name="author" content="Kurt Neufeld & Mike Warren">

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<!-- <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"> -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimal-ui">

<link rel="stylesheet" href="css/reveal.css">
<link rel="stylesheet" href="css/theme/moon.css" id="theme">

<!-- Code syntax highlighting -->
<!-- <link rel="stylesheet" href="lib/css/zenburn.css"> -->
<link rel="stylesheet" href="lib/css/solarized_dark.css">

<!-- Printing and PDF exports -->
<script>
var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
document.getElementsByTagName( 'head' )[0].appendChild( link );
</script>

<!--[if lt IE 9]>
      <script src="lib/js/html5shiv.js"></script>
      <![endif]-->


<style type="text/css">
.reveal li small { vertical-align: middle; }
.reveal img { vertical-align: middle; }
#who_is img { margin-right: 20px; }
dl { text-align: left; }
dl dt { text-align: left; }
dl dd { text-align: left; }

img { 
  background-color: white !important;
  text-shadow: none;
}

section
{
  text-align: left;
}

.small
{
  font-size: 75% !important;
}

tt, code, pre {
  font-family: 'Source Code Pro', monospace;
}

tt {
  color: #78bae6;
}

code
{
  font-size: 120% !important;
}

pre > code
{
  background: #002b36 !important;
}

.aside
{
  font-size: 75% !important;
  opacity: 0.5;
}

</style>

</head>

<body>

<div class="reveal">

  <!-- Any section element inside of this container is displayed as a slide -->
  <div class="slides">

    <section>
      <h1>Event-Based Programming</h1>
      <hr/>
      <h2>Twisted and boost::asio</h2>
    </section>

    <section style="background-image: url(images/mike-transparent.svg); background-repeat: no-repeat; background-size: 300px; background-position: top right;">
      <!-- <img src="images/mike-transparent.svg" style="background: rgba(0, 0, 0, 0.0); width: 40%; height: auto; border: none; margin-left: 1em; float:right;" /> -->
      <!-- <object type="image/svg+xml" data="images/mike-transparent.svg" style="background: rgba(0, 0, 0, 0.0); width: 40%; height: auto; border: none; margin-left: 1em; float:right;"></object> -->
      <div style="float:left; max-width: 45%;">
      <h2>Twisted <span class="small">via Python</span></h2>
      <p>Mike Warren</p>
      <p><a href="https://@meejah.ca">https://<span style="font-size: 150%; text-shadow: 2px 2px 1px rgba(0, 0, 0, 0.5); text-decoration: underline; -moz-text-decoration-color: rgba(255, 64, 64, 0.5);">@meejah</span>.ca</a></p>
      </div>
    </section>

    <section style="min-height: 30% !important; background-image: url(images/kurt.png); background-size: 300px; background-repeat: no-repeat; background-position: top right;">
      <h2>boost::asio <span class="small">via C++</span></h2>
      <p>Kurt Neufeld</p>
      <p><a href="http://www.burgundywall.com">burgundywall.com</a></p>
      <p><a href="https://twitter.com/kneufeld">@kneufeld</a></p>
    </section>

    <section>
      <h2>Talk Outline</h2>
      <ul>
        <li class="fragment">Event-Based Programming Overview</li>
        <li class="fragment">example: chat server</li>
        <li class="fragment">Programming with Twisted</li>
        <li class="fragment">Programming with boost::asio</li>
      </ul>
    </section>

    <section>
      <h2>Overview: background</h2>
      <ul>
        <li class="fragment">Two kinds of programs:</li>
        <ul>
          <li class="fragment">CPU-bound <span class="aside">(no waiting)</span></li>
          <li class="fragment">I/O-bound <span class="aside">(waiting)<span></li>
        </ul>
        <li class="fragment">Threading: CPU</li>
        <li class="fragment">Event based: I/O</li>
      </ul>
    </section>

    <section>
      <h2>Definitions...</h2>
        <dl class="fragment">
          <dt><a href="http://en.wikipedia.org/wiki/Synchronization_%28computer_science%29">syncronous</a></dt>
          <dd>(concept) a blocking call, does not return until data or error
          <pre><code>ec = read(fd, buffer);</code></pre>
        </dd>
        </dl>
        <br/>
        <dl class="fragment">
          <dt><a href="http://en.wikipedia.org/wiki/Asynchronous_I/O">asyncronous</a></dt>
          <dd>(concept) a non-blocking call, returns instantly, callback happens <em>later</em>
          <pre><code data-trim>read(fd, callback);
// as a different function
void callback(ec, buffer);</code></pre></dd>
        </dl>
    </section>

    <section>
      <h2>Definitions...</h2>
        <dl class="fragment">
          <dt><a href="http://en.wikipedia.org/wiki/Event_%28computing%29">event</a></dt>
          <dd>(verb) an occurence that requires some sort of handling,
          usually with associate data</dd>
        </dl>
        <dl class="fragment">
          <dt><a href="http://en.wikipedia.org/wiki/Thread_%28computing%29">thread</a></dt>
          <dd>(noun) the smallest sequence of instructions that can be
          independently scheduled and run</dd>
        </dl>
        <dl class="fragment">
          <dt><a href="http://en.wikipedia.org/wiki/Context_switch">context switch</a></dt>
          <dd>(verb) storing/restoring the state of a thread
          before/after getting cpu time. expensive</dd>
        </dl>
    </section>

    <section>
      <h2>Definitions...</h2>
        <dl class="fragment">
          <dt><a href="http://en.wikipedia.org/wiki/Reactor_pattern">reactor</a></dt>
          <dd>(pattern) waits for events and then calls handler to perform
          actual read or write</dd>
        </dl>
        <dl class="fragment">
          <dt><a href="http://en.wikipedia.org/wiki/Proactor_pattern">proactor</a></dt>
          <dd>(pattern) waits for events and performs the read or write,
          passing any accociated data to the handler. asynchronous variant of reactor</dd>
        </dl>
    </section>

    <section>
      <h2>Threaded I/O</h2>
      <img src="images/threaded-io.svg" style="padding: 0.5em; border: none;">
    </section>

    <section>
      <h2>Threaded I/O</h2>
      <img src="images/threaded-io-contextswitches.svg" style="padding: 0.5em; border: none;">
    </section>

    <section>
      <h2>Event-based I/O</h2>
      <img src="images/event-based-io.svg" style="padding: 0.5em; height: 500px;">
    </section>

    <section>
      <h2>Event-based I/O</h2>
      <img src="images/event-based-io-arrows.svg" style="padding: 0.5em; height: 500px;">
    </section>

    <section>
      <h2>Event-based vs. Threading</h2>
      <ul>
        <li class="fragment">OS resources</li>
        <li class="fragment">Context-switching <span class="aside">(latency, overhead)</span></li>
        <li class="fragment">Complexity</li>
        <li class="fragment">One core?! <span class="aside">(e.g. share socket)</span></li>
        <li class="fragment">Repeatability/testing</li>
      </ul>
    </section>

    <section data-state="moon">
      <h2>Event-Based Programming</h2>
      <ul>
        <li class="fragment">&ldquo;event&rdquo; &rarr; run code</li>
        <li class="fragment">event: timer, data arrives<br/><span class="aside">(network, user, disk, etc.)</span></li>
        <li class="fragment">code: &ldquo;callback&rdquo; <span class="aside">errback</span></li>
        <li class="fragment">Pattern: Reactor or Proactor <span class="aside">(&ldquo;Gang of Four&rdquo;)</span></li>
        <li class="fragment">Twisted: reactor</li>
        <li class="fragment">ASIO: both</li>
      </ul>
    </section>

<!--
    <section>
      <h2>What is event based programming?</h2>
      <p class="fragment">First some history...</p>
      <p class="fragment">Traditionally, scalability has been achieved by using
      multiple threads or multiple processes. Apache for instance, can be configured
      to use either.</p>
      <p class="fragment">Since threads can run concurrently in a
      single process, a well written threaded program can be extremely
      fast.</p>
      <p class="fragment">Unfortunately Amdahl's law states (basically) that there
      is always some part of a system that can't be parallelized and
      therefore infinite cores does not yield infinite speedup.</p>
      <p class="fragment">But mostly threads suck because threaded programming
      is <em>hard</em>.</p>
    </section>

    <section data-state="moon">
      <h2>What is event based programming?</h2>
      <div style="text-align: left">
        <dl class="fragment">
          <dt>event</dt>
          <dd>(noun)</dd>
        </dl>
      </div>
      <p class="fragment">Event based programs are based on a loop that sits
      around and waits for... events. An event can be a timer, network packet,
      mouse click, basically anything that the operating system can notify you
      about asynchronously.</p>
      <p class="fragment">A function that registers itself to be notified on a given
      event is named a <tt>callback</tt> and that callback handles the event.</p>
    </section>
-->


    <!-- set data-state to moon before/after setting solarized -->
    <section data-state="solarized">
      <h2>twisted</h2>
      <pre style="font-size: 100%;">git clone https://meejah.ca/polyglot-txchat</pre>
      <ul>
        <li class="fragment">https://twistedmatrix.com</li>
        <li class="fragment">Since 2001</li>
        <li class="fragment">330k Line of Ccode <span class="aside">(168k is tests)</span></li>
        <li class="fragment">TCP, UDP, ... SSH, HTTPS, XMPP</li>
        <li class="fragment">Servers, clients, ...</li>
      </ul>
    </section>

    <section>
      <h2>twisted</h2>
      <ul>
        <li class="fragment">Endpoints: <code>TCP4ServerEndpoint TCP4ClientEndpoint</code></li>
        <li class="fragment">Transports: <code>ITLSTransport ITCPTransport</code></li>
        <li class="fragment">Protocols: <code>ClientFactory, ServerFactory</code></li>
        <li class="fragment">Follow <code>IProtocol</code></li>
      </ul>
    </section>

    <section> <!-- dep. injection -->
        <section data-transition="none"> <!-- dep. injection -->
          <h2>twisted</h2>
              <pre><code>class ChatServer(Protocol):
        def __init__(self, factory, decoder=msgpack.Unpacker()):
            self.factory = factory
            self.decoder = decoder

        def dataReceived(self, data):
            pass
        def makeConnection(self, transport):
            pass
        def connectionMade(self, reason):
            pass
        def connectionLost(self, reason):
            pass
              </code></pre>
        </section>

        <section data-transition="none">
          <h2>twisted</h2>
              <pre><code>class ChatServer(Protocol):
        def __init__(self, factory, decoder=msgpack.Unpacker()):
            self.factory = factory
            self.decoder = decoder

        def dataReceived(self, data):
            self.decoder.feed(data)
            for msg in self.decoder:  # XXX
                self.got_message(msg)
        def makeConnection(self, transport):
            pass
        def connectionMade(self, reason):
            pass
        def connectionLost(self, reason):
            pass
              </code></pre>
        </section>

        <section data-transition="none">
          <h2>twisted</h2>
              <pre><code>class ChatServer(Protocol):
              </code></pre>
        </section>

        <section data-transition="none">
          <h2>twisted</h2>
              <pre><code>class ChatServer(Protocol):
              </code></pre>
        </section>
    </section>

    <section data-state="solarized">
      <h2>twisted</h2>
      <ul>
        <li class="fragment"></li>
        <li class="fragment"></li>
      </ul>
    </section>

    <section data-state="moon">
      <h2>boost::asio</h2>
      <div style="text-align: left">
      <dl class="fragment">
        <dt>boost</dt>
        <dd>the greatest open source c++ library ever</dd>
        <dd><em>lots</em> of pieces, <tt>asio</tt> is just one of them</dd>
      </dl>
      <dl class="fragment">
        <dt>asio</dt>
        <dd>asynchronous input/output</dd>
        <dd>a cross-platform C++ library for network and low-level I/O programming</dd>
      </dl>
    </div>
    </section>

    <section>
      <h2>asio connection sequence</h2>
      <p>simplified</p>
      <img src="images/tcp_start.png"/>
    </section>

    <section>
      <h2>chat server sequence</h2>
      <img src="images/msg_forward.png"/>
    </section>

    <section>
      <h2>Performance</h2>
      <div style="float: left">
      <table>
        <thead>
          <tr><th>Var</th><th>Value</th></tr>
        </thead>
        <tbody>
        <tr class="fragment" data-fragment-index=1>
          <td># clients</td>
          <td>15</td>
        </tr>
        <tr class="fragment" data-fragment-index=1>
          <td>send delay</td>
          <td>1ms</td>
        </tr>
        <tr class="fragment" data-fragment-index=1>
          <td>msg size</td>
          <td>21 bytes</td>
        </tr>
        <tr class="fragment" data-fragment-index=2>
          <td>total msg recv</td>
          <td>638,316</td>
        </tr>
        <tr class="fragment" data-fragment-index=2>
          <td>total msg sent</td>
          <td>8,935,859</td>
        </tr>
        <tr class="fragment" data-fragment-index=3>
          <td>msg/sec</td>
          <td>161,983</td>
        </tr>
        </tbody>
      </table>
      <p class="fragment" data-fragment-index=4>zero optimizations</p>
      <p class="fragment" data-fragment-index=5>running in debug mode</p>
    </section>

    <section style="text-align: left;">
      <h1>THE END</h1>
      <div class="fragment">
      <h3>Thanks in part to..</h3>
      <ul>
        <li><a href="http://lab.hakim.se/reveal-js/">http://lab.hakim.se/reveal-js/</a></li>
      </ul>
    </section>

    <section style="text-align: center">
      <h1>You Guys!</h1>
      <h3 class="fragment">(and polyglot)</h3>
    </section>

  </div><!-- slides -->

</div!-- reveal -->

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>

// Full list of configuration options available at:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({
controls: true,
progress: true,
history: true,
center: false,
mouseWheel: false,
slideNumber: true,

width: 1024,
height: 768,

transition: 'slide', // none/fade/slide/convex/concave/zoom

// Optional reveal.js plugins
dependencies: [
{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
{ src: 'plugin/zoom-js/zoom.js', async: true },
{ src: 'plugin/notes/notes.js', async: true }
]
});

Reveal.addEventListener('moon', function() {
  document.getElementById('theme').setAttribute('href','css/theme/moon.css');
    });
Reveal.addEventListener('solarized', function() {
  document.getElementById('theme').setAttribute('href','css/theme/solarized.css');
    });
</script>

</body>
</html>
